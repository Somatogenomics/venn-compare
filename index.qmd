---
title: "VennCompare"
format:
  html:
    page-layout: full
filters:
  - shinylive
---

```{shinylive-r}
#| standalone: true
#| viewerHeight: 700

library(shiny)
library(bslib)

# Compute exclusive intersections
compute_intersections <- function(sets) {
  if (length(sets) == 0) return(NULL)
  set_names <- names(sets)
  n <- length(sets)
  results <- list()
  
  for (i in 1:(2^n - 1)) {
    binary <- as.integer(intToBits(i))[1:n]
    included <- which(binary == 1)
    excluded <- which(binary == 0)
    
    if (length(included) == 1) {
      intersection <- sets[[included]]
    } else {
      intersection <- Reduce(intersect, sets[included])
    }
    
    if (length(excluded) > 0) {
      for (ex in excluded) {
        intersection <- setdiff(intersection, sets[[ex]])
      }
    }
    
    if (length(intersection) > 0) {
      combo_name <- paste(set_names[included], collapse = " & ")
      results[[combo_name]] <- list(
        elements = intersection,
        count = length(intersection),
        sets_included = set_names[included],
        n_sets = length(included)
      )
    }
  }
  return(results)
}

ui <- page_sidebar(

title = "VennCompare",
theme = bs_theme(bootswatch = "flatly"),

sidebar = sidebar(
  width = 320,
  numericInput("n_sets", "Number of sets:", value = 4, min = 2, max = 7, step = 1),
  selectInput("case_handling", "Case handling:",
              choices = c("As is" = "asis", "UPPERCASE" = "upper", "lowercase" = "lower")),
  checkboxInput("trim_ws", "Trim whitespace", TRUE),
  hr(),
  actionButton("example_btn", "Load Example", class = "btn-info btn-sm"),
  actionButton("clear_btn", "Clear All", class = "btn-warning btn-sm"),
  hr(),
  uiOutput("set_inputs")
),

navset_card_tab(
  nav_panel("Diagram", plotOutput("main_plot", height = "500px")),
  nav_panel("Intersections",
    layout_columns(
      col_widths = c(5, 7),
      card(card_header("Intersections"), 
           div(style = "max-height:400px;overflow-y:auto;", uiOutput("int_list"))),
      card(card_header("Elements"), 
           uiOutput("sel_header"),
           verbatimTextOutput("sel_elements"))
    )
  ),
  nav_panel("Summary", tableOutput("summary_tbl")),
  nav_panel("Union/Common",
    layout_columns(
      col_widths = c(6, 6),
      card(card_header("Union"), verbatimTextOutput("union_out")),
      card(card_header("Common to all"), verbatimTextOutput("common_out"))
    )
  )
)
)

server <- function(input, output, session) {

rv <- reactiveValues(sel_int = NULL)

output$set_inputs <- renderUI({
  n <- input$n_sets
  lapply(1:n, function(i) {
    div(style = "margin-bottom:8px;",
        textInput(paste0("name_", i), NULL, value = paste0("Set", i), width = "100px"),
        textAreaInput(paste0("set_", i), NULL, placeholder = "One item per line", 
                      height = "70px", width = "100%"))
  })
})

get_sets <- reactive({
  req(input$n_sets)
  sets <- list()
  for (i in 1:input$n_sets) {
    txt <- input[[paste0("set_", i)]]
    nm <- input[[paste0("name_", i)]]
    if (!is.null(txt) && nchar(txt) > 0) {
      els <- strsplit(txt, "\n")[[1]]
      if (input$trim_ws) els <- trimws(els)
      els <- els[els != ""]
      if (input$case_handling == "upper") els <- toupper(els)
      if (input$case_handling == "lower") els <- tolower(els)
      els <- unique(els)
      if (length(els) > 0) {
        name <- if (!is.null(nm) && nchar(nm) > 0) nm else paste0("Set", i)
        sets[[name]] <- els
      }
    }
  }
  sets
})

observeEvent(input$example_btn, {
  ex <- list(
    c("BRCA1","TP53","EGFR","KRAS","MYC","CDK4","RB1","PTEN"),
    c("TP53","EGFR","MYC","CDK4","VEGFA","HIF1A","NOTCH1"),
    c("BRCA1","TP53","MYC","PTEN","AKT1","PIK3CA","MTOR"),
    c("EGFR","KRAS","MYC","BRAF","VEGFA","HIF1A","AKT1")
  )
  for (i in 1:min(input$n_sets, 4)) {
    updateTextAreaInput(session, paste0("set_", i), value = paste(ex[[i]], collapse = "\n"))
    updateTextInput(session, paste0("name_", i), value = paste0("GeneSet", i))
  }
})

observeEvent(input$clear_btn, {
  for (i in 1:7) {
    updateTextAreaInput(session, paste0("set_", i), value = "")
    updateTextInput(session, paste0("name_", i), value = paste0("Set", i))
  }
})

output$main_plot <- renderPlot({
  sets <- get_sets()
  req(length(sets) >= 2)
  n <- length(sets)
  cols <- c("#E41A1C","#377EB8","#4DAF4A","#984EA3","#FF7F00","#A65628","#F781BF")[1:n]
  
  if (n <= 4) {
    par(mar = c(1,1,2,1))
    plot(0, 0, type = "n", xlim = c(-4,4), ylim = c(-4,4), asp = 1, axes = FALSE, xlab = "", ylab = "")
    title(paste("Comparison of", n, "Sets"), cex.main = 1.3)
    
    if (n == 2) {
      centers <- list(c(-1,0), c(1,0)); r <- 1.8
      lblpos <- list(c(-2.5,2), c(2.5,2))
    } else if (n == 3) {
      centers <- list(c(-1,0.6), c(1,0.6), c(0,-1)); r <- 1.6
      lblpos <- list(c(-2.5,2.2), c(2.5,2.2), c(0,-3))
    } else {
      centers <- list(c(-1.2,0.8), c(1.2,0.8), c(-0.6,-0.8), c(0.6,-0.8)); r <- 1.5
      lblpos <- list(c(-2.8,2.2), c(2.8,2.2), c(-2.2,-2.5), c(2.2,-2.5))
    }
    
    theta <- seq(0, 2*pi, length.out = 100)
    for (i in 1:n) {
      x <- centers[[i]][1] + r * cos(theta)
      y <- centers[[i]][2] + r * sin(theta)
      polygon(x, y, border = cols[i], col = adjustcolor(cols[i], 0.15), lwd = 2.5)
      text(lblpos[[i]][1], lblpos[[i]][2], names(sets)[i], col = cols[i], font = 2, cex = 1.2)
    }
    
    all_int <- length(Reduce(intersect, sets))
    text(0, 0, all_int, cex = 1.5, font = 2)
    
  } else {
    ints <- compute_intersections(sets)
    if (is.null(ints)) return()
    counts <- sapply(ints, function(x) x$count)
    ints <- ints[order(-counts)]
    if (length(ints) > 15) ints <- ints[1:15]
    
    par(mar = c(5,10,3,2))
    barplot(rev(sapply(ints, function(x) x$count)), 
            names.arg = rev(names(ints)), horiz = TRUE, las = 1,
            col = "#4a4a4a", border = NA, xlab = "Count",
            main = paste("Top Intersections (", n, " sets)"))
  }
})

ints_data <- reactive({
  sets <- get_sets()
  req(length(sets) >= 2)
  compute_intersections(sets)
})

output$int_list <- renderUI({
  ints <- ints_data()
  req(length(ints) > 0)
  ints <- ints[order(-sapply(ints, function(x) x$count))]
  tagList(lapply(names(ints), function(nm) {
    actionButton(paste0("btn_", gsub("[^a-zA-Z0-9]", "_", nm)),
                 paste0(ints[[nm]]$count, " - ", nm),
                 class = "btn btn-light btn-sm",
                 style = "width:100%;text-align:left;margin-bottom:3px;font-size:12px;")
  }))
})

observe({
  ints <- ints_data()
  req(length(ints) > 0)
  for (nm in names(ints)) {
    local({
      int_nm <- nm
      bid <- paste0("btn_", gsub("[^a-zA-Z0-9]", "_", int_nm))
      observeEvent(input[[bid]], { rv$sel_int <- int_nm }, ignoreInit = TRUE)
    })
  }
})

output$sel_header <- renderUI({
  req(rv$sel_int)
  ints <- ints_data()
  req(rv$sel_int %in% names(ints))
  div(style = "background:#e8f4f8;padding:8px;border-radius:4px;margin-bottom:8px;border-left:3px solid #3498db;",
      strong(rv$sel_int), br(),
      span(style = "color:#666;", paste(ints[[rv$sel_int]]$count, "elements")))
})

output$sel_elements <- renderText({
  req(rv$sel_int)
  ints <- ints_data()
  req(rv$sel_int %in% names(ints))
  paste(ints[[rv$sel_int]]$elements, collapse = "\n")
})

output$summary_tbl <- renderTable({
  ints <- ints_data()
  req(length(ints) > 0)
  df <- data.frame(
    Intersection = names(ints),
    Count = sapply(ints, function(x) x$count),
    Elements = sapply(ints, function(x) paste(head(x$elements, 5), collapse = ", "))
  )
  df[order(-df$Count), ]
}, striped = TRUE, hover = TRUE)

output$union_out <- renderText({
  sets <- get_sets()
  req(length(sets) >= 2)
  u <- sort(unique(unlist(sets)))
  paste0("Total: ", length(u), "\n\n", paste(u, collapse = "\n"))
})

output$common_out <- renderText({
  sets <- get_sets()
  req(length(sets) >= 2)
  common <- Reduce(intersect, sets)
  if (length(common) > 0) {
    paste0("Total: ", length(common), "\n\n", paste(sort(common), collapse = "\n"))
  } else {
    "No common elements"
  }
})

}

shinyApp(ui, server)
```
